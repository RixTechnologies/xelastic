
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../how-to-guides/">
      
      
        <link rel="next" href="../explanation/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.1">
    
    
      
        <title>Reference - xelastic</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.402914a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#xelastic" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="xelastic" class="md-header__button md-logo" aria-label="xelastic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            xelastic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="xelastic" class="md-nav__button md-logo" aria-label="xelastic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    xelastic
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        How-To
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Reference
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xelastic" class="md-nav__link">
    xelastic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xelastic.xelastic" class="md-nav__link">
    xelastic
  </a>
  
    <nav class="md-nav" aria-label="xelastic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_clear" class="md-nav__link">
    __bulk_clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_create_action" class="md-nav__link">
    __bulk_create_action()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_flush" class="md-nav__link">
    __bulk_flush()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.aggIndex" class="md-nav__link">
    aggIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_close" class="md-nav__link">
    bulk_close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_index" class="md-nav__link">
    bulk_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_set" class="md-nav__link">
    bulk_set()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.countIndex" class="md-nav__link">
    countIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.createTermFilter" class="md-nav__link">
    createTermFilter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.deleteIndexes" class="md-nav__link">
    deleteIndexes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.end" class="md-nav__link">
    end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.existsIndex" class="md-nav__link">
    existsIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getData" class="md-nav__link">
    getData()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getDataX" class="md-nav__link">
    getDataX()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getIndexes" class="md-nav__link">
    getIndexes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.indexName" class="md-nav__link">
    indexName()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.mlt" class="md-nav__link">
    mlt()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryBuckets" class="md-nav__link">
    queryBuckets()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryCardinality" class="md-nav__link">
    queryCardinality()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryIndex" class="md-nav__link">
    queryIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.request" class="md-nav__link">
    request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll" class="md-nav__link">
    scroll()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_close" class="md-nav__link">
    scroll_close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_set" class="md-nav__link">
    scroll_set()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_total" class="md-nav__link">
    scroll_total()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setRefresh" class="md-nav__link">
    setRefresh()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setSource" class="md-nav__link">
    setSource()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setUpdBody" class="md-nav__link">
    setUpdBody()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.start" class="md-nav__link">
    start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.termvectors" class="md-nav__link">
    termvectors()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.updateFields" class="md-nav__link">
    updateFields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.updateFieldsById" class="md-nav__link">
    updateFieldsById()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../explanation/" class="md-nav__link">
        Explanation
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#xelastic" class="md-nav__link">
    xelastic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xelastic.xelastic" class="md-nav__link">
    xelastic
  </a>
  
    <nav class="md-nav" aria-label="xelastic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_clear" class="md-nav__link">
    __bulk_clear()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_create_action" class="md-nav__link">
    __bulk_create_action()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__bulk_flush" class="md-nav__link">
    __bulk_flush()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.aggIndex" class="md-nav__link">
    aggIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_close" class="md-nav__link">
    bulk_close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_index" class="md-nav__link">
    bulk_index()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.bulk_set" class="md-nav__link">
    bulk_set()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.countIndex" class="md-nav__link">
    countIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.createTermFilter" class="md-nav__link">
    createTermFilter()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.deleteIndexes" class="md-nav__link">
    deleteIndexes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.end" class="md-nav__link">
    end()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.existsIndex" class="md-nav__link">
    existsIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getData" class="md-nav__link">
    getData()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getDataX" class="md-nav__link">
    getDataX()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.getIndexes" class="md-nav__link">
    getIndexes()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.indexName" class="md-nav__link">
    indexName()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.mlt" class="md-nav__link">
    mlt()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryBuckets" class="md-nav__link">
    queryBuckets()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryCardinality" class="md-nav__link">
    queryCardinality()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.queryIndex" class="md-nav__link">
    queryIndex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.request" class="md-nav__link">
    request()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll" class="md-nav__link">
    scroll()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_close" class="md-nav__link">
    scroll_close()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_set" class="md-nav__link">
    scroll_set()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.scroll_total" class="md-nav__link">
    scroll_total()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setRefresh" class="md-nav__link">
    setRefresh()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setSource" class="md-nav__link">
    setSource()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.setUpdBody" class="md-nav__link">
    setUpdBody()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.start" class="md-nav__link">
    start()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.termvectors" class="md-nav__link">
    termvectors()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.updateFields" class="md-nav__link">
    updateFields()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xelastic.xelastic.updateFieldsById" class="md-nav__link">
    updateFieldsById()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Reference</h1>

<div class="doc doc-object doc-module">


<a id="xelastic"></a>
  <div class="doc doc-contents first">
  
      <p>Created on Wed Apr 14 10:56:39 2021</p>
<pre><code>Elasticsearch interface class. Provides easy handling of scroll and bulk
requests as well as handling of time split indexes.

External methods
    setSource
    indexName
    start
    end
    request
    getIndexes
    deleteIndexes
    getData
    getDataX
    save
    existsIndex
    countIndex
    queryIndex
    aggIndex
    queryBuckets
    queryCardinality
    setRefresh
    createTermFilter
    setUpdBody
    updateFields
    updateFieldsById
    ========== Scroll API
    scroll_set
    scroll_total
    scroll
    scroll_close
    ========== Bulk API
    bulk_set
    bulk_index
    bulk_close
    ==========
    termvectors
    mlt

The xelastic class uses index names of the format: prefix-stub-source-span
Where
    prefix is shared by all indexes of the application
    stub identifies indexes of a particular type
    source identifies a particular data set
    span identifies a particular time period (span)

prefix-stub is used in index templates thus these are indexes with identic
settings and mappings

esconf is the dictionary of the following form
        connection:
            current: &lt;name of the selected connection&gt;
            &lt;Name of the connection 1&gt;:
                client: &lt;client url&gt;
                cert: &lt;path to the certificte file&gt;, optional
                usr: [&lt;user name&gt;, &lt;password&gt;] for authentification, optional
            &lt;Name of the connection 2&gt;:
            ... 
        prefix: &lt;prefix of the application index names&gt;
        source: &lt;application default source ID&gt;
        indexes:
            &lt;index key 1&gt;:
                stub: &lt;stub&gt;
                span_type: &lt;valid span type id: d, m, q, y or n&gt;
                date_field: &lt;date field to split the indexes on&gt;, must be set
                        for all span types except n
                shared: &lt;True or False&gt;, specifies the index shared for all
                        sources, default False, optional
            &lt;index key 2&gt;
            ...
        keep: &lt;time to keep scroll batch&gt; defaults to '10s'
        scroll_size: &lt;amoun of the scroll batch in bytes&gt; defaults to 100
        max_buckets: &lt;maximum buckets in es aggregation&gt;, defaults to 99
        index_bulk: &lt;number of rows in an index bulk&gt;, defaults to 1000
        high: &lt;Maximum allowed used disk space %&gt;, defaults to 90%, execution
                is aborted if the used space is higher
        headers: &lt;headers for the http request&gt;,
                defaults to {Content-Type: application/json}


Response codes: 200 (ok), 201 (created succesfully), 400 (bad request), 401 (not authorised)
</code></pre>
<p>@author: juris.rats</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="xelastic.xelastic" class="doc doc-heading">
        <code>xelastic</code>


</h2>


  <div class="doc doc-contents ">

  
      


        <details class="quote">
          <summary>Source code in <code>mdl\xelastic.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">xelastic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esconf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">index_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the instance:</span>
<span class="sd">            esconf - configuration dictionary for the Elasticsearch connection</span>
<span class="sd">            index_key - the index key for the instance</span>
<span class="sd">            terms - terms dictionary of form {key1: value1, key2: value2, ...}</span>
<span class="sd">                to handle subset of the data</span>
<span class="sd">            mode - may set mode for all requests for the current class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index_key</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">index_key</span> <span class="ow">in</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
                <span class="sa">f</span><span class="s2">&quot;Nepareiza indeksa atslēga </span><span class="si">{</span><span class="n">index_key</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Handle index configuration</span>
        <span class="n">index_conf</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">][</span><span class="n">index_key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_key</span> <span class="o">=</span> <span class="n">index_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="n">terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">=</span> <span class="n">index_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;span_type&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;q&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">),</span>\
            <span class="sa">f</span><span class="s2">&quot;Wrong index span type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span> <span class="o">=</span> <span class="n">index_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_field&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span><span class="p">,</span> \
            <span class="sa">f</span><span class="s2">&quot;Date field must be set for index of span type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stub</span> <span class="o">=</span> <span class="n">index_conf</span><span class="p">[</span><span class="s1">&#39;stub&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">=</span> <span class="n">index_conf</span><span class="p">[</span><span class="s1">&#39;span_type&#39;</span><span class="p">]</span>

        <span class="c1"># Retrieving specified connection and environment keys</span>
        <span class="n">ckey</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="s1">&#39;current&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es_client</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">][</span><span class="s1">&#39;client&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cert&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">usr</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usr&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">usr</span> <span class="k">else</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="o">*</span><span class="n">usr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span>
                                  <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;10s&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index_bulk&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_buckets</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_buckets&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scroll_size</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scroll_size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># placeholder for update scripts</span>

        <span class="c1"># Retrieve the Elasticsearch version</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es_doc</span> <span class="o">=</span> <span class="s1">&#39;/_doc/&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="s1">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># indicates that bulk indexing is not initialized</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_usageOk</span><span class="p">(</span><span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span> <span class="c1"># Aborts if disk usage too high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_usageOk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aborts if disk usage is more as configuration es/high value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&quot;_cat/allocation&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">usage</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Disk usage </span><span class="si">{</span><span class="n">usage</span><span class="si">}</span><span class="s2">% - exceeds allowed </span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">%&quot;</span>

    <span class="k">def</span> <span class="nf">setSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

    <span class="k">def</span> <span class="nf">indexName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get index name for the stub, source and epoch.</span>

<span class="sd">        If span_type == &#39;n&#39; SPAN_ALL is used as span in the index name</span>
<span class="sd">        Otherwise</span>
<span class="sd">            if epoch set span is calculated from the epoch</span>
<span class="sd">            else * is used for span (all spans addressed)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">SPAN_ALL</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">epoch</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">span</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span>
                    <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">))</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span>
                    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">))),</span>
                    <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">)))</span>
                <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">span</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the start epoch of the span</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanType</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">quarter</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">quarter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the end epoch of the span</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">quarter</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">quarter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">))</span> <span class="o">+</span>
                       <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_next_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyear</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">xmonth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns year and month for the next month</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">xyear</span><span class="p">,</span> <span class="n">xmonth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">xmonth</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="k">else</span> <span class="p">(</span><span class="n">xyear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes parameter string of form ?par1&amp;par2 ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">body</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper on _request_json. Converts dictionary &lt;body&gt; to json string</span>

<span class="sd">        NB!! Does not use self.filter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_json</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                  <span class="n">xdate</span><span class="p">,</span> <span class="n">use_index_key</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper to the requests method request. Body is a json string. </span>
<span class="sd">        In most cases called from request method. Directly used e.g. for bulk</span>
<span class="sd">        indexing.</span>

<span class="sd">        If use_index_key set to False, does not use index name for es request</span>

<span class="sd">        Values for refresh:</span>
<span class="sd">            not set or False - no refresh actions</span>
<span class="sd">            wait for - waits for the refresh to proceed</span>
<span class="sd">            empty string or true (not recommended) - immedially refreh the</span>
<span class="sd">                relevant index shards</span>

<span class="sd">        Values for mode: </span>
<span class="sd">            None (run) to run silently</span>
<span class="sd">            f (fake) to log parameters without running the request</span>
<span class="sd">            v (or any other value - verbose) to run and log data</span>
<span class="sd">        Mode might be set by the methods parameter or by the instance variable</span>
<span class="sd">        If both set parameter has a precedence.</span>

<span class="sd">        Returns requests object resp:</span>
<span class="sd">           status_code - http status code</span>
<span class="sd">           text - returned result as a json or text</span>
<span class="sd">           json() - converting the returned result to python list, use</span>
<span class="sd">              only for the requests returning json, do not use for _cat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_client</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_key</span> <span class="ow">and</span> <span class="n">use_index_key</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexName</span><span class="p">(</span><span class="n">xdate</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="n">endpoint</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="n">endpoint</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">seq_primary</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_seq_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_primary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;if_primary_term&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_primary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;refresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refresh</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span> <span class="c1"># Add url parameters if specified</span>
            <span class="c1">#req = requests.get(url, params=params)</span>
            <span class="c1">#url = req.url</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;command </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">, index_key </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_key</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; url </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> body </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="c1"># execute dummy request</span>
            <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_client</span><span class="p">,</span>
                            <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
                            <span class="n">verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert</span><span class="p">,</span>
                            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">body</span><span class="p">,</span>
                                    <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
                                    <span class="n">verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert</span><span class="p">,</span>
                                    <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getIndexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of existing index names for the index key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_settings&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>   <span class="c1"># Mo indexes found, return empty list</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">deleteIndexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes indexes of the list &lt;indexes&gt;</span>
<span class="sd">        Returns True if all indexes deleted succesfully</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
            <span class="c1"># set index name directly to handle indexes with time spans -</span>
            <span class="c1"># here indexes have to be deleted one by one</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                                <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;acknowledged&#39;</span><span class="p">):</span>
                <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">success</span>

    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve data for &lt;xid&gt; from the current index</span>

<span class="sd">        Returns the item data (_source) or None if item with id &lt;xid&gt; not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDataX</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_source&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">resp</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">getDataX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve data for &lt;xid&gt; from the current index</span>

<span class="sd">        Returns the full json (_source and metadata) or None if item with id &lt;xid&gt; not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_doc&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Index an item</span>
<span class="sd">        Adds to the data body self.terms to save the data of the terms fields</span>

<span class="sd">        Returns id of the created item or None on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">body</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;_doc/&#39;</span>
        <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">+=</span> <span class="n">xid</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="n">seq_primary</span><span class="p">,</span>
                            <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                            <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span>  <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">201</span><span class="p">:</span> <span class="c1"># resource created</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">existsIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if index exists, false otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexName</span><span class="p">()</span>
        <span class="c1">#index_name = &#39;xxx&#39;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_cat/indices/</span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2">?h=s,idx&amp;format=json&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;existsIndex returned status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">countIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the items in index_key according to the criteria in body</span>
<span class="sd">        Adds self.filter if set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_count&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">queryIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns list of requested rows and total count of matching rows</span>
<span class="sd">        If no results - returns empty list and 0</span>
<span class="sd">        When error returns empty list and the error type (string)</span>
<span class="sd">        Adds self.filter if set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_search&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;hits&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">hits</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">],</span> <span class="n">hits</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="c1"># Index not found</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">aggIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns list of returned rows of aggregated values and count of documents in smaller groups</span>
<span class="sd">        Adds self.filter if set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_search&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># If no data returned response dictionary has no &lt;aggregations&gt; item</span>
            <span class="k">return</span>  <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregations&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="c1"># Index not found</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># request failed</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">queryBuckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">max_buckets</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the buckets data on &lt;field&gt;.</span>

<span class="sd">        Returns a dictionary of form key: doc count, and the number of other</span>
<span class="sd">        documents (not aggregated)</span>

<span class="sd">        If quiet==False logs sum_other_doc_count</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mbuckets</span> <span class="o">=</span> <span class="n">max_buckets</span> <span class="k">if</span> <span class="n">max_buckets</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_buckets</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mbuckets</span><span class="p">}}}}</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">body</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
        <span class="n">aggs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggIndex</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="c1">#print(body, index_key, aggs)</span>
        <span class="k">if</span> <span class="n">aggs</span><span class="p">:</span>
            <span class="n">buckets</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s1">&#39;agg&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span>
            <span class="n">others</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s1">&#39;agg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sum_other_doc_count&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">others</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">others</span><span class="si">}</span><span class="s2"> items not aggregated: &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mbuckets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">xbuckets</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;doc_count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">xbuckets</span><span class="p">,</span> <span class="n">others</span>     

    <span class="k">def</span> <span class="nf">queryCardinality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the number of unique values of &lt;field&gt; (cardniality)</span>
<span class="sd">        Adds self.filter if set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">&quot;cardinality&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span>
        <span class="p">}}}}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_search&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>

        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;aggregations&quot;</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">setRefresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;1s&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets refresh interval for the index xkey to period.</span>
<span class="sd">        Period has form &#39;xxxs&#39; where xxx is number of seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;refresh_interval&quot;</span><span class="p">:</span> <span class="n">period</span><span class="p">}}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_settings&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> _settings &quot;</span> 
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">createTermFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates terms filter ([{&quot;term&quot;: {&lt;field&gt;: &lt;value&gt;}}, ...]) from the</span>
<span class="sd">        &lt;terms&gt; dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">}}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_addFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If self.terms set creates new filter merging body/query and self.terms</span>

<span class="sd">        Uses a copy of the body parameter to avoid changing the parameter value</span>

<span class="sd">        Otherwise just returns body</span>

<span class="sd">        NB. Query transfered in the body parameter must be a list!!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">body</span>

        <span class="n">xbody</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">xfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createTermFilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">xbody</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="c1"># Set self.filter as a query</span>
            <span class="n">xbody</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfilter</span>
        <span class="k">elif</span> <span class="n">query</span> <span class="ow">and</span> <span class="s1">&#39;bool&#39;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="c1"># the body query is a bool query</span>
            <span class="k">if</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="s1">&#39;bool&#39;</span><span class="p">]:</span>
                <span class="n">xbody</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;bool&#39;</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">xbody</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">][</span><span class="s1">&#39;bool&#39;</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xfilter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># body query is a simple query, transform to bool query</span>
            <span class="c1"># Assumed that a simple query should be converted to must query</span>
            <span class="n">xbody</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bool&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">xfilter</span><span class="p">],</span>
                <span class="s1">&#39;must&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>
            <span class="p">}}</span>
        <span class="k">return</span> <span class="n">xbody</span>

    <span class="k">def</span> <span class="nf">setUpdBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">upd_fields</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">del_fields</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name - name of th update script</span>
<span class="sd">        upd_fields - fields to update</span>
<span class="sd">        del_fields - fields to remove</span>
<span class="sd">        mode not used</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updFields</span><span class="p">(</span><span class="n">upd_fields</span><span class="p">,</span> <span class="n">del_fields</span><span class="p">),</span>
                <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">}}</span>

    <span class="k">def</span> <span class="nf">updateFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xfilter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update / delete fields for items filtered by xfilter (update by query)</span>
<span class="sd">        If update body &lt;name&gt; has update fields, &lt;values&gt; must be specified</span>

<span class="sd">        Returns number of updated items if updates successful, -1 otherwise</span>
<span class="sd">        Logs errors on failure</span>
<span class="sd">        {&quot;took&quot;: ?, &quot;timed_out&quot;: false, &quot;total&quot;: ?, &quot;updated&quot;: ?, ...}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">body</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfilter</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">body</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;_update_by_query&#39;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                            <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> date </span><span class="si">{</span><span class="n">xdate</span><span class="si">}</span><span class="s2"> &quot;</span> 
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tagline&#39;</span><span class="p">):</span> <span class="c1"># updateFields executed in fake mode &#39;f&#39;</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="c1"># pretend everything is ok</span>

        <span class="n">updated</span> <span class="o">=</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">updated</span> <span class="o">&lt;</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timed_out&#39;</span><span class="p">))):</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">updated</span>

    <span class="k">def</span> <span class="nf">updateFieldsById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update fields for item with ident &lt;xid&gt;</span>

<span class="sd">        If &lt;seq_primary&gt; is specified as a tuple (item_seq, primary_term),</span>
<span class="sd">        updates only if the _item_seq and _primary_term of the item</span>
<span class="sd">        matches ones specified</span>

<span class="sd">        Returns the update response in form</span>
<span class="sd">        {&#39;_index&#39;: ?, &#39;_type&#39;: &#39;_doc&#39;, &#39;_id&#39;: ?, &#39;_version&#39;: ?, &#39;result&#39;: &#39;updated&#39;,</span>
<span class="sd">         &#39;_shards&#39;: {&#39;total&#39;: ?, &#39;successful&#39;: ?, &#39;failed&#39;: ?},</span>
<span class="sd">         &#39;_seq_no&#39;: ?, &#39;_primary_term&#39;: ?}</span>

<span class="sd">        or None on failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">body</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_doc&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="s2">&quot;_update&quot;</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="n">seq_primary</span><span class="p">,</span>
                            <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> date </span><span class="si">{</span><span class="n">xdate</span><span class="si">}</span><span class="s2"> &quot;</span> 
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq_primary</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_updFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upd_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">del_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">upd_script</span> <span class="o">=</span>  <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">upd_fields</span> <span class="k">else</span> \
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ctx._source.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">=params[&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39;]&quot;</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">upd_fields</span><span class="p">]</span>
        <span class="n">del_script</span> <span class="o">=</span>  <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">del_fields</span> <span class="k">else</span>   \
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ctx._source.remove(&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39;)&quot;</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">del_fields</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upd_script</span><span class="o">+</span><span class="n">del_script</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1">#       Scroll API</span>
<span class="c1"># =============================================================================</span>
    <span class="k">def</span> <span class="nf">scroll_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new scroll. Scroll is set no matter of mode value.</span>

<span class="sd">        Batch ends when scroll returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_search?scroll=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span> <span class="o">=</span> <span class="s2">&quot;_search/scroll&quot;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;first </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span><span class="si">}</span><span class="s2">, next </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; body </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_hits</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">scroll_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the total count of rows matching the request</span>
<span class="sd">        ES count method used as search does not return the exact count for</span>
<span class="sd">        large sets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">countIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scroll_next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the next scroll batch from &lt;resp&gt; and sets the instance variables</span>
<span class="sd">        Mode not used in this call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">jresp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="c1"># If no more data, buffer stays empty</span>
            <span class="n">total_hits</span> <span class="o">=</span> <span class="n">jresp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hits&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">total_hits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_hits</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_hits</span> <span class="o">=</span> <span class="n">total_hits</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">jresp</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hits&#39;</span><span class="p">,[])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span> <span class="o">=</span> <span class="n">jresp</span><span class="p">[</span><span class="s1">&#39;_scroll_id&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;scroll&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span>
                    <span class="s1">&#39;scroll_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the next item from the scroll buffer (the item of ES hits list).</span>

<span class="sd">        If the process is not initialized yet executes the first scroll request</span>
<span class="sd">        If the buffer is empty, retrieves the next batch of items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;endpoint_first&#39;</span><span class="p">),</span> <span class="s1">&#39;Scroll not initialized&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
            <span class="c1"># Buffer is empty, get new batch of data</span>
            <span class="c1"># If the buffer is not empty do nothing here but go and</span>
            <span class="c1"># return the next item from the batch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scroll_next_batch</span><span class="p">(</span>
                    <span class="c1"># Executes the request for each but the first batch</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span><span class="p">,</span>
                                 <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Executes the request for the first batch of items</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scroll_next_batch</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scroll_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the scroll buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scroll_id&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;/_search/scroll&#39;</span><span class="p">,</span>
                     <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1">#       Bulk API</span>
<span class="c1"># =============================================================================</span>
    <span class="k">def</span> <span class="nf">bulk_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bulk_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a bulk index</span>
<span class="sd">        If included in the call bulk_max overrides one set on class initialization</span>

<span class="sd">        refresh is transfered to the request method. Possible values - None</span>

<span class="sd">        Sets the refresh interval if specified in &lt;refresh_interval&gt;</span>

<span class="sd">        Mode not used in this call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_refresh</span> <span class="o">=</span> <span class="n">refresh</span>
        <span class="k">if</span> <span class="n">refresh_interval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setRefresh</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">refresh_interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date_field</span>
        <span class="k">if</span> <span class="n">bulk_max</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span> <span class="o">=</span> <span class="n">bulk_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__bulk_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the bulk buffer, resets the bulk item counter and error flag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">bulk_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the item data to the bulk. If bulk full flush it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Bulk indexing not initialized! Execute bulk_set()&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span><span class="p">,</span> <span class="s2">&quot;bulk counter overflow&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_flush</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="c1"># Set index action if not specified</span>
        <span class="c1"># If span type is not n (date_field set) transfer the item date</span>
        <span class="c1"># as it is used to create the index name</span>
        <span class="n">xdate</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span> <span class="k">else</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span><span class="p">]</span>
        <span class="n">bulk_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_create_action</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">)</span>

        <span class="n">bulk_item</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bulk_action</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="c1"># input(bulk_item)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">+=</span> <span class="n">bulk_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">bulk_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes the last batch to the index and sets refresh interval to 1 second</span>

<span class="sd">        Returns True if no errors in flush and setRefresh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_flush</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># indicates that bulk indexing is not initialized</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setRefresh</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1s&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__bulk_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Flushes to the index and clears the bulk</span>
<span class="sd">        Sets the error flag if flush failed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="c1"># nothing to flush</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_json</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_bulk&#39;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_refresh</span><span class="p">,</span>
                                  <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__bulk_create_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns basic bulk action for bulk indexing</span>
<span class="sd">        Handles differences between ES versions prior to 7 (demands _type) and 7 (does not allow _type)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">getIndexName</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">xdate</span><span class="p">)</span>
        <span class="n">xaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="n">index_name</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">xaction</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_doc&quot;</span>
        <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
            <span class="n">xaction</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xid</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">action</span><span class="p">:</span> <span class="n">xaction</span><span class="p">})</span>

<span class="c1">###############################################################################</span>
    <span class="k">def</span> <span class="nf">termvectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">xfield</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves term vector data for the item &lt;id&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_termvectors&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">xfield</span><span class="p">],</span>
                <span class="s2">&quot;offsets&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;payloads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;term_statistics&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;field_statistics&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;max_num_terms&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s2">&quot;min_term_freq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;min_doc_freq&quot;</span><span class="p">:</span> <span class="mi">2</span>
                  <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;term_vectors&#39;</span><span class="p">][</span><span class="n">xfield</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">mlt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xids</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">mlt_conf</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves more-like-this query for &lt;xids&gt; and configuration &lt;mlt_conf&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">mlt_conf</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">],</span> <span class="s2">&quot;like&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xids</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;min_term_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;max_query_terms&#39;</span><span class="p">,</span> <span class="s1">&#39;min_doc_freq&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;max_doc_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;min_word_length&#39;</span><span class="p">,</span> <span class="s1">&#39;max_word_length&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">mlt_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pars</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;more-like-this </span><span class="si">{</span><span class="n">pars</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;more_like_this&quot;</span><span class="p">:</span> <span class="n">pars</span><span class="p">}</span>

<span class="c1"># =============================================================================</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;client=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">es_client</span><span class="si">}</span><span class="s2">, source=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(</span><span class="si">{self.es_client}</span><span class="s2">,</span><span class="si">{self.es_version}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.__bulk_clear" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__bulk_clear</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Clears the bulk buffer, resets the bulk item counter and error flag</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__bulk_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clears the bulk buffer, resets the bulk item counter and error flag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.__bulk_create_action" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__bulk_create_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns basic bulk action for bulk indexing
Handles differences between ES versions prior to 7 (demands _type) and 7 (does not allow _type)</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__bulk_create_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns basic bulk action for bulk indexing</span>
<span class="sd">    Handles differences between ES versions prior to 7 (demands _type) and 7 (does not allow _type)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">getIndexName</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">xdate</span><span class="p">)</span>
    <span class="n">xaction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_index&quot;</span><span class="p">:</span> <span class="n">index_name</span><span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">xaction</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_doc&quot;</span>
    <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
        <span class="n">xaction</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xid</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">action</span><span class="p">:</span> <span class="n">xaction</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.__bulk_flush" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__bulk_flush</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Flushes to the index and clears the bulk
Sets the error flag if flush failed</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__bulk_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flushes to the index and clears the bulk</span>
<span class="sd">    Sets the error flag if flush failed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="c1"># nothing to flush</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_json</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_bulk&#39;</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_refresh</span><span class="p">,</span>
                              <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">esconf</span><span class="p">,</span> <span class="n">index_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  

<details class="initializes-the-instance">
  <summary>Initializes the instance</summary>
  <p>esconf - configuration dictionary for the Elasticsearch connection
index_key - the index key for the instance
terms - terms dictionary of form {key1: value1, key2: value2, ...}
    to handle subset of the data
mode - may set mode for all requests for the current class instance</p>
</details>
      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">esconf</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">index_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the instance:</span>
<span class="sd">        esconf - configuration dictionary for the Elasticsearch connection</span>
<span class="sd">        index_key - the index key for the instance</span>
<span class="sd">        terms - terms dictionary of form {key1: value1, key2: value2, ...}</span>
<span class="sd">            to handle subset of the data</span>
<span class="sd">        mode - may set mode for all requests for the current class instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">index_key</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">index_key</span> <span class="ow">in</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
            <span class="sa">f</span><span class="s2">&quot;Nepareiza indeksa atslēga </span><span class="si">{</span><span class="n">index_key</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Handle index configuration</span>
    <span class="n">index_conf</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">][</span><span class="n">index_key</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">index_key</span> <span class="o">=</span> <span class="n">index_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="n">terms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">=</span> <span class="n">index_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;span_type&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;q&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">),</span>\
        <span class="sa">f</span><span class="s2">&quot;Wrong index span type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span> <span class="o">=</span> <span class="n">index_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_field&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span><span class="p">,</span> \
        <span class="sa">f</span><span class="s2">&quot;Date field must be set for index of span type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stub</span> <span class="o">=</span> <span class="n">index_conf</span><span class="p">[</span><span class="s1">&#39;stub&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">=</span> <span class="n">index_conf</span><span class="p">[</span><span class="s1">&#39;span_type&#39;</span><span class="p">]</span>

    <span class="c1"># Retrieving specified connection and environment keys</span>
    <span class="n">ckey</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="s1">&#39;current&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">es_client</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">][</span><span class="s1">&#39;client&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cert&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">usr</span> <span class="o">=</span> <span class="n">esconf</span><span class="p">[</span><span class="s1">&#39;connection&#39;</span><span class="p">][</span><span class="n">ckey</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;usr&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">usr</span> <span class="k">else</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="o">*</span><span class="n">usr</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span>
                              <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;10s&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index_bulk&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_buckets</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_buckets&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scroll_size</span> <span class="o">=</span> <span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scroll_size&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># placeholder for update scripts</span>

    <span class="c1"># Retrieve the Elasticsearch version</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">es_doc</span> <span class="o">=</span> <span class="s1">&#39;/_doc/&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">es_version</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="k">else</span> <span class="s1">&#39;/&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># indicates that bulk indexing is not initialized</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_usageOk</span><span class="p">(</span><span class="n">esconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span> <span class="c1"># Aborts if disk usage too high</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">setSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.aggIndex" class="doc doc-heading">
<code class="highlight language-python"><span class="n">aggIndex</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns list of returned rows of aggregated values and count of documents in smaller groups
Adds self.filter if set</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">aggIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns list of returned rows of aggregated values and count of documents in smaller groups</span>
<span class="sd">    Adds self.filter if set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_search&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="c1"># If no data returned response dictionary has no &lt;aggregations&gt; item</span>
        <span class="k">return</span>  <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aggregations&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="c1"># Index not found</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># request failed</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.bulk_close" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bulk_close</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Flushes the last batch to the index and sets refresh interval to 1 second</p>
<p>Returns True if no errors in flush and setRefresh</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bulk_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flushes the last batch to the index and sets refresh interval to 1 second</span>

<span class="sd">    Returns True if no errors in flush and setRefresh</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_flush</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># indicates that bulk indexing is not initialized</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setRefresh</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1s&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkerror</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.bulk_index" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bulk_index</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Adds the item data to the bulk. If bulk full flush it</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bulk_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds the item data to the bulk. If bulk full flush it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Bulk indexing not initialized! Execute bulk_set()&quot;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span><span class="p">,</span> <span class="s2">&quot;bulk counter overflow&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_flush</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;index&#39;</span> <span class="c1"># Set index action if not specified</span>
    <span class="c1"># If span type is not n (date_field set) transfer the item date</span>
    <span class="c1"># as it is used to create the index name</span>
    <span class="n">xdate</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span> <span class="k">else</span> <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span><span class="p">]</span>
    <span class="n">bulk_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_create_action</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">)</span>

    <span class="n">bulk_item</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bulk_action</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># input(bulk_item)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">+=</span> <span class="n">bulk_item</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulkcurr</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.bulk_set" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bulk_set</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bulk_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initializes a bulk index
If included in the call bulk_max overrides one set on class initialization</p>
<p>refresh is transfered to the request method. Possible values - None</p>
<p>Sets the refresh interval if specified in <refresh_interval></p>
<p>Mode not used in this call</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bulk_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bulk_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a bulk index</span>
<span class="sd">    If included in the call bulk_max overrides one set on class initialization</span>

<span class="sd">    refresh is transfered to the request method. Possible values - None</span>

<span class="sd">    Sets the refresh interval if specified in &lt;refresh_interval&gt;</span>

<span class="sd">    Mode not used in this call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulk_refresh</span> <span class="o">=</span> <span class="n">refresh</span>
    <span class="k">if</span> <span class="n">refresh_interval</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setRefresh</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">refresh_interval</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bulk_date_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date_field</span>
    <span class="k">if</span> <span class="n">bulk_max</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_max</span> <span class="o">=</span> <span class="n">bulk_max</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__bulk_clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.countIndex" class="doc doc-heading">
<code class="highlight language-python"><span class="n">countIndex</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Counts the items in index_key according to the criteria in body
Adds self.filter if set</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">countIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts the items in index_key according to the criteria in body</span>
<span class="sd">    Adds self.filter if set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_count&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.createTermFilter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">createTermFilter</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Creates terms filter ([{"term": {<field>: <value>}}, ...]) from the
<terms> dictionary</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">createTermFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates terms filter ([{&quot;term&quot;: {&lt;field&gt;: &lt;value&gt;}}, ...]) from the</span>
<span class="sd">    &lt;terms&gt; dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">}}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.deleteIndexes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">deleteIndexes</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Deletes indexes of the list <indexes>
Returns True if all indexes deleted succesfully</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">deleteIndexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes indexes of the list &lt;indexes&gt;</span>
<span class="sd">    Returns True if all indexes deleted succesfully</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
        <span class="c1"># set index name directly to handle indexes with time spans -</span>
        <span class="c1"># here indexes have to be deleted one by one</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;acknowledged&#39;</span><span class="p">):</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">success</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.end" class="doc doc-heading">
<code class="highlight language-python"><span class="n">end</span><span class="p">(</span><span class="n">span</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the end epoch of the span</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the end epoch of the span</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;q&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">quarter</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">quarter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;d&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">))</span> <span class="o">+</span>
                   <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.existsIndex" class="doc doc-heading">
<code class="highlight language-python"><span class="n">existsIndex</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns True if index exists, false otherwise</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">existsIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns True if index exists, false otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexName</span><span class="p">()</span>
    <span class="c1">#index_name = &#39;xxx&#39;</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_cat/indices/</span><span class="si">{</span><span class="n">index_name</span><span class="si">}</span><span class="s2">?h=s,idx&amp;format=json&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">assert</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;existsIndex returned status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.getData" class="doc doc-heading">
<code class="highlight language-python"><span class="n">getData</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieve data for <xid> from the current index</p>
<p>Returns the item data (_source) or None if item with id <xid> not found</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve data for &lt;xid&gt; from the current index</span>

<span class="sd">    Returns the item data (_source) or None if item with id &lt;xid&gt; not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDataX</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_source&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">resp</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.getDataX" class="doc doc-heading">
<code class="highlight language-python"><span class="n">getDataX</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieve data for <xid> from the current index</p>
<p>Returns the full json (_source and metadata) or None if item with id <xid> not found</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getDataX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve data for &lt;xid&gt; from the current index</span>

<span class="sd">    Returns the full json (_source and metadata) or None if item with id &lt;xid&gt; not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_doc&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.getIndexes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">getIndexes</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Return a list of existing index names for the index key</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getIndexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of existing index names for the index key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_settings&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>   <span class="c1"># Mo indexes found, return empty list</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.indexName" class="doc doc-heading">
<code class="highlight language-python"><span class="n">indexName</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get index name for the stub, source and epoch.</p>
<p>If span_type == 'n' SPAN_ALL is used as span in the index name
Otherwise
    if epoch set span is calculated from the epoch
    else * is used for span (all spans addressed)</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">indexName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get index name for the stub, source and epoch.</span>

<span class="sd">    If span_type == &#39;n&#39; SPAN_ALL is used as span in the index name</span>
<span class="sd">    Otherwise</span>
<span class="sd">        if epoch set span is calculated from the epoch</span>
<span class="sd">        else * is used for span (all spans addressed)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">SPAN_ALL</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">epoch</span><span class="p">:</span>
        <span class="n">span</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span>
                <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">))</span> <span class="o">//</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span>
                <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">))),</span>
                <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">ts</span><span class="p">)))</span>
            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">span</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.mlt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mlt</span><span class="p">(</span><span class="n">xids</span><span class="p">,</span> <span class="n">mlt_conf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieves more-like-this query for <xids> and configuration <mlt_conf></p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mlt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xids</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">mlt_conf</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves more-like-this query for &lt;xids&gt; and configuration &lt;mlt_conf&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="n">mlt_conf</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">],</span> <span class="s2">&quot;like&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xids</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;min_term_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;max_query_terms&#39;</span><span class="p">,</span> <span class="s1">&#39;min_doc_freq&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;max_doc_freq&#39;</span><span class="p">,</span> <span class="s1">&#39;min_word_length&#39;</span><span class="p">,</span> <span class="s1">&#39;max_word_length&#39;</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">mlt_conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;more-like-this </span><span class="si">{</span><span class="n">pars</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;more_like_this&quot;</span><span class="p">:</span> <span class="n">pars</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.queryBuckets" class="doc doc-heading">
<code class="highlight language-python"><span class="n">queryBuckets</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_buckets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieves the buckets data on <field>.</p>
<p>Returns a dictionary of form key: doc count, and the number of other
documents (not aggregated)</p>
<p>If quiet==False logs sum_other_doc_count</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">queryBuckets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_buckets</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the buckets data on &lt;field&gt;.</span>

<span class="sd">    Returns a dictionary of form key: doc count, and the number of other</span>
<span class="sd">    documents (not aggregated)</span>

<span class="sd">    If quiet==False logs sum_other_doc_count</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mbuckets</span> <span class="o">=</span> <span class="n">max_buckets</span> <span class="k">if</span> <span class="n">max_buckets</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_buckets</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">mbuckets</span><span class="p">}}}}</span>
    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
    <span class="n">aggs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggIndex</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="c1">#print(body, index_key, aggs)</span>
    <span class="k">if</span> <span class="n">aggs</span><span class="p">:</span>
        <span class="n">buckets</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s1">&#39;agg&#39;</span><span class="p">][</span><span class="s1">&#39;buckets&#39;</span><span class="p">]</span>
        <span class="n">others</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s1">&#39;agg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sum_other_doc_count&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">others</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">others</span><span class="si">}</span><span class="s2"> items not aggregated: &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">index_key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mbuckets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">xbuckets</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;doc_count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">xbuckets</span><span class="p">,</span> <span class="n">others</span>     
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.queryCardinality" class="doc doc-heading">
<code class="highlight language-python"><span class="n">queryCardinality</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieve the number of unique values of <field> (cardniality)
Adds self.filter if set</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">queryCardinality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the number of unique values of &lt;field&gt; (cardniality)</span>
<span class="sd">    Adds self.filter if set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;cardinality&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span>
    <span class="p">}}}}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_search&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>

    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;aggregations&quot;</span><span class="p">][</span><span class="s2">&quot;agg&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.queryIndex" class="doc doc-heading">
<code class="highlight language-python"><span class="n">queryIndex</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns list of requested rows and total count of matching rows
If no results - returns empty list and 0
When error returns empty list and the error type (string)
Adds self.filter if set</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">queryIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns list of requested rows and total count of matching rows</span>
<span class="sd">    If no results - returns empty list and 0</span>
<span class="sd">    When error returns empty list and the error type (string)</span>
<span class="sd">    Adds self.filter if set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;_search&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;hits&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">hits</span><span class="p">[</span><span class="s1">&#39;hits&#39;</span><span class="p">],</span> <span class="n">hits</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="c1"># Index not found</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.request" class="doc doc-heading">
<code class="highlight language-python"><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Wrapper on _request_json. Converts dictionary <body> to json string</p>
<p>NB!! Does not use self.filter</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">body</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper on _request_json. Converts dictionary &lt;body&gt; to json string</span>

<span class="sd">    NB!! Does not use self.filter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_json</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                              <span class="n">xdate</span><span class="p">,</span> <span class="n">use_index_key</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Index an item
Adds to the data body self.terms to save the data of the terms fields</p>
<p>Returns id of the created item or None on failure</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">xid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Index an item</span>
<span class="sd">    Adds to the data body self.terms to save the data of the terms fields</span>

<span class="sd">    Returns id of the created item or None on failure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">body</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;_doc/&#39;</span>
    <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
        <span class="n">endpoint</span> <span class="o">+=</span> <span class="n">xid</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="n">seq_primary</span><span class="p">,</span>
                        <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                        <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span>  <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">201</span><span class="p">:</span> <span class="c1"># resource created</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.scroll" class="doc doc-heading">
<code class="highlight language-python"><span class="n">scroll</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the next item from the scroll buffer (the item of ES hits list).</p>
<p>If the process is not initialized yet executes the first scroll request
If the buffer is empty, retrieves the next batch of items</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the next item from the scroll buffer (the item of ES hits list).</span>

<span class="sd">    If the process is not initialized yet executes the first scroll request</span>
<span class="sd">    If the buffer is empty, retrieves the next batch of items</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;endpoint_first&#39;</span><span class="p">),</span> <span class="s1">&#39;Scroll not initialized&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
        <span class="c1"># Buffer is empty, get new batch of data</span>
        <span class="c1"># If the buffer is not empty do nothing here but go and</span>
        <span class="c1"># return the next item from the batch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scroll_next_batch</span><span class="p">(</span>
                <span class="c1"># Executes the request for each but the first batch</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span><span class="p">,</span>
                             <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">use_index_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Executes the request for the first batch of items</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scroll_next_batch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.scroll_close" class="doc doc-heading">
<code class="highlight language-python"><span class="n">scroll_close</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Removes the scroll buffer.</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scroll_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the scroll buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scroll_id&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;/_search/scroll&#39;</span><span class="p">,</span>
                 <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.scroll_set" class="doc doc-heading">
<code class="highlight language-python"><span class="n">scroll_set</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initializes a new scroll. Scroll is set no matter of mode value.</p>
<p>Batch ends when scroll returns None</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scroll_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes a new scroll. Scroll is set no matter of mode value.</span>

<span class="sd">    Batch ends when scroll returns None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addFilter</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_search?scroll=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keep</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span> <span class="o">=</span> <span class="s2">&quot;_search/scroll&quot;</span>
    <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;first </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_first</span><span class="si">}</span><span class="s2">, next </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_next</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; body </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scroll_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">total_hits</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.scroll_total" class="doc doc-heading">
<code class="highlight language-python"><span class="n">scroll_total</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieves the total count of rows matching the request
ES count method used as search does not return the exact count for
large sets</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scroll_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves the total count of rows matching the request</span>
<span class="sd">    ES count method used as search does not return the exact count for</span>
<span class="sd">    large sets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">countIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.setRefresh" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setRefresh</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s1">&#39;1s&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Sets refresh interval for the index xkey to period.
Period has form 'xxxs' where xxx is number of seconds</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setRefresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s1">&#39;1s&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets refresh interval for the index xkey to period.</span>
<span class="sd">    Period has form &#39;xxxs&#39; where xxx is number of seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;refresh_interval&quot;</span><span class="p">:</span> <span class="n">period</span><span class="p">}}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;_settings&#39;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> _settings &quot;</span> 
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ok</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.setSource" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Changes the source</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setSource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Changes the source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.setUpdBody" class="doc doc-heading">
<code class="highlight language-python"><span class="n">setUpdBody</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">upd_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">del_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>name - name of th update script
upd_fields - fields to update
del_fields - fields to remove
mode not used</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setUpdBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">upd_fields</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">del_fields</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    name - name of th update script</span>
<span class="sd">    upd_fields - fields to update</span>
<span class="sd">    del_fields - fields to remove</span>
<span class="sd">    mode not used</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updFields</span><span class="p">(</span><span class="n">upd_fields</span><span class="p">,</span> <span class="n">del_fields</span><span class="p">),</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">}}</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="n">span</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the start epoch of the span</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the start epoch of the span</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanType</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">span</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;q&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">quarter</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">quarter</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_type</span><span class="o">==</span><span class="s1">&#39;d&#39;</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">day</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.termvectors" class="doc doc-heading">
<code class="highlight language-python"><span class="n">termvectors</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="n">xfield</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Retrieves term vector data for the item <id></p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">termvectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">xfield</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves term vector data for the item &lt;id&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_termvectors&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">))</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">xfield</span><span class="p">],</span>
            <span class="s2">&quot;offsets&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;payloads&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;term_statistics&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;field_statistics&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;max_num_terms&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;min_term_freq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;min_doc_freq&quot;</span><span class="p">:</span> <span class="mi">2</span>
              <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>        
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> error </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;term_vectors&#39;</span><span class="p">][</span><span class="n">xfield</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.updateFields" class="doc doc-heading">
<code class="highlight language-python"><span class="n">updateFields</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xfilter</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update / delete fields for items filtered by xfilter (update by query)
If update body <name> has update fields, <values> must be specified</p>
<p>Returns number of updated items if updates successful, -1 otherwise
Logs errors on failure
{"took": ?, "timed_out": false, "total": ?, "updated": ?, ...}</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">updateFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xfilter</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update / delete fields for items filtered by xfilter (update by query)</span>
<span class="sd">    If update body &lt;name&gt; has update fields, &lt;values&gt; must be specified</span>

<span class="sd">    Returns number of updated items if updates successful, -1 otherwise</span>
<span class="sd">    Logs errors on failure</span>
<span class="sd">    {&quot;took&quot;: ?, &quot;timed_out&quot;: false, &quot;total&quot;: ?, &quot;updated&quot;: ?, ...}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">body</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfilter</span>
    <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;_update_by_query&#39;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                        <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> date </span><span class="si">{</span><span class="n">xdate</span><span class="si">}</span><span class="s2"> &quot;</span> 
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">rj</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tagline&#39;</span><span class="p">):</span> <span class="c1"># updateFields executed in fake mode &#39;f&#39;</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="c1"># pretend everything is ok</span>

    <span class="n">updated</span> <span class="o">=</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">updated</span> <span class="o">&lt;</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timed_out&#39;</span><span class="p">))):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">rj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">updated</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="xelastic.xelastic.updateFieldsById" class="doc doc-heading">
<code class="highlight language-python"><span class="n">updateFieldsById</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Update fields for item with ident <xid></p>
<p>If <seq_primary> is specified as a tuple (item_seq, primary_term),
updates only if the _item_seq and _primary_term of the item
matches ones specified</p>
<p>Returns the update response in form
{'_index': ?, '_type': '_doc', '_id': ?, '_version': ?, 'result': 'updated',
 '_shards': {'total': ?, 'successful': ?, 'failed': ?},
 '_seq_no': ?, '_primary_term': ?}</p>
<p>or None on failure</p>

      <details class="quote">
        <summary>Source code in <code>mdl\xelastic.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">updateFieldsById</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">xdate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update fields for item with ident &lt;xid&gt;</span>

<span class="sd">    If &lt;seq_primary&gt; is specified as a tuple (item_seq, primary_term),</span>
<span class="sd">    updates only if the _item_seq and _primary_term of the item</span>
<span class="sd">    matches ones specified</span>

<span class="sd">    Returns the update response in form</span>
<span class="sd">    {&#39;_index&#39;: ?, &#39;_type&#39;: &#39;_doc&#39;, &#39;_id&#39;: ?, &#39;_version&#39;: ?, &#39;result&#39;: &#39;updated&#39;,</span>
<span class="sd">     &#39;_shards&#39;: {&#39;total&#39;: ?, &#39;successful&#39;: ?, &#39;failed&#39;: ?},</span>
<span class="sd">     &#39;_seq_no&#39;: ?, &#39;_primary_term&#39;: ?}</span>

<span class="sd">    or None on failure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upd_bodies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;_doc&#39;</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="s2">&quot;_update&quot;</span><span class="p">))</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">seq_primary</span><span class="o">=</span><span class="n">seq_primary</span><span class="p">,</span>
                        <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">xdate</span><span class="o">=</span><span class="n">xdate</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> date </span><span class="si">{</span><span class="n">xdate</span><span class="si">}</span><span class="s2"> &quot;</span> 
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq_primary</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.b78d2936.min.js"></script>
      
    
  </body>
</html>